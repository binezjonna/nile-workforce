// كود JavaScript للوحة التحكم

document.addEventListener('DOMContentLoaded', function() {
    
    // التحقق من حالة تسجيل الدخول
    checkLoginStatus();
    
    // تهيئة الأحداث
    initializeEvents();
    
    // تحميل وتحديث البيانات
    loadApplications();
    
    // إعداد التهيئة الافتراضية
    setupDefaultLogin();
});

// تهيئة الأحداث
function initializeEvents() {
    // زر تسجيل الدخول
    const loginBtn = document.getElementById('loginBtn');
    if (loginBtn) {
        loginBtn.addEventListener('click', handleLogin);
    }
    
    // زر تسجيل الخروج
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }
    
    // زر البحث
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    if (searchBtn) {
        searchBtn.addEventListener('click', () => filterApplications());
    }
    if (searchInput) {
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') filterApplications();
        });
    }
    
    // الفلاتر
    const sectorFilter = document.getElementById('sectorFilter');
    const governorateFilter = document.getElementById('governorateFilter');
    if (sectorFilter) {
        sectorFilter.addEventListener('change', filterApplications);
    }
    if (governorateFilter) {
        governorateFilter.addEventListener('change', filterApplications);
    }
    
    // زر التحديث
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadApplications);
    }
    
    // زر تصدير البيانات
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportData);
    }
}

// التحقق من حالة تسجيل الدخول
function checkLoginStatus() {
    const isLoggedIn = localStorage.getItem('nileAdminLoggedIn') === 'true';
    const loginModal = document.getElementById('loginModal');
    
    if (!isLoggedIn && loginModal) {
        loginModal.style.display = 'flex';
    } else if (loginModal) {
        loginModal.style.display = 'none';
    }
}

// إعداد بيانات الدخول الافتراضية
function setupDefaultLogin() {
    // تخزين بيانات الدخول الافتراضية إذا لم تكن موجودة
    if (!localStorage.getItem('adminCredentials')) {
        const defaultCredentials = {
            username: 'admin',
            password: 'nile2024'
        };
        localStorage.setItem('adminCredentials', JSON.stringify(defaultCredentials));
    }
}

// معالجة تسجيل الدخول
function handleLogin() {
    const username = document.getElementById('adminUsername').value.trim();
    const password = document.getElementById('adminPassword').value;
    
    // الحصول على بيانات الاعتماد المخزنة
    const storedCredentials = JSON.parse(localStorage.getItem('adminCredentials'));
    
    if (username === storedCredentials.username && password === storedCredentials.password) {
        // تسجيل الدخول الناجح
        localStorage.setItem('nileAdminLoggedIn', 'true');
        
        // إخفاء نافذة تسجيل الدخول
        const loginModal = document.getElementById('loginModal');
        if (loginModal) {
            loginModal.style.display = 'none';
        }
        
        // تحميل البيانات
        loadApplications();
        
        // عرض رسالة ترحيب
        alert('مرحباً بك في لوحة تحكم Nile Work Force!');
    } else {
        alert('اسم المستخدم أو كلمة المرور غير صحيحة');
    }
}

// معالجة تسجيل الخروج
function handleLogout(event) {
    event.preventDefault();
    
    if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        localStorage.removeItem('nileAdminLoggedIn');
        window.location.reload();
    }
}

// تحميل طلبات التوظيف
function loadApplications() {
    // الحصول على البيانات من LocalStorage
    const applications = JSON.parse(localStorage.getItem('nileWorkForceApplications')) || [];
    
    // تحديث الإحصائيات
    updateStatistics(applications);
    
    // عرض البيانات في الجدول
    displayApplications(applications);
}

// تحديث الإحصائيات
function updateStatistics(applications) {
    const total = applications.length;
    const today = new Date().toLocaleDateString('ar-EG');
    
    // حساب الإحصائيات
    const hotelSector = applications.filter(app => app.jobSector === 'الفنادق').length;
    const resortSector = applications.filter(app => app.jobSector === 'المنتجعات').length;
    const todayApplications = applications.filter(app => {
        const appDate = new Date(app.submissionDate || app.id).toLocaleDateString('ar-EG');
        return appDate === today;
    }).length;
    
    // تحديث الواجهة
    document.getElementById('totalApplications').textContent = total;
    document.getElementById('hotelSector').textContent = hotelSector;
    document.getElementById('resortSector').textContent = resortSector;
    document.getElementById('todayApplications').textContent = todayApplications;
}

// عرض الطلبات في الجدول
function displayApplications(applications) {
    const tableBody = document.getElementById('applicationsTableBody');
    if (!tableBody) return;
    
    // مسح المحتوى الحالي
    tableBody.innerHTML = '';
    
    if (applications.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align: center; padding: 40px;">
                    <i class="fas fa-inbox" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                    <p>لا توجد طلبات توظيف حتى الآن</p>
                </td>
            </tr>
        `;
        return;
    }
    
    // عرض كل طلب في صف
    applications.forEach((app, index) => {
        const row = document.createElement('tr');
        
        // تنسيق التاريخ
        const date = app.submissionDate ? 
            new Date(app.submissionDate).toLocaleDateString('ar-EG') : 
            new Date(app.id).toLocaleDateString('ar-EG');
        
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${app.fullName || 'غير محدد'}</td>
            <td>${app.nationalId || 'غير محدد'}</td>
            <td>${app.phone || 'غير محدد'}</td>
            <td>${app.governorate || 'غير محدد'}</td>
            <td><span class="sector-badge">${app.jobSector || 'غير محدد'}</span></td>
            <td>${app.experience || 'غير محدد'}</td>
            <td>${date}</td>
            <td>
                <button class="action-btn view-btn" data-id="${app.id}">
                    <i class="fas fa-eye"></i> عرض
                </button>
                <button class="action-btn delete delete-btn" data-id="${app.id}">
                    <i class="fas fa-trash"></i> حذف
                </button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // إضافة أحداث للأزرار
    addTableEvents();
}

// إضافة أحداث لأزرار الجدول
function addTableEvents() {
    // أزرار العرض
    document.querySelectorAll('.view-btn').forEach(button => {
        button.addEventListener('click', function() {
            const appId = this.getAttribute('data-id');
            showApplicationDetails(appId);
        });
    });
    
    // أزرار الحذف
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const appId = this.getAttribute('data-id');
            deleteApplication(appId);
        });
    });
}

// عرض تفاصيل المتقدم
function showApplicationDetails(appId) {
    const applications = JSON.parse(localStorage.getItem('nileWorkForceApplications')) || [];
    const application = applications.find(app => app.id == appId);
    
    if (!application) {
        document.getElementById('detailsContent').innerHTML = '<p>لم يتم العثور على بيانات المتقدم</p>';
        return;
    }
    
    // تنسيق التفاصيل
    const detailsContent = document.getElementById('detailsContent');
    detailsContent.innerHTML = `
        <div class="detail-item">
            <div class="detail-label"><i class="fas fa-user"></i> المعلومات الشخصية</div>
            <p><strong>الاسم:</strong> ${application.fullName || 'غير محدد'}</p>
            <p><strong>الرقم القومي:</strong> ${application.nationalId || 'غير محدد'}</p>
            <p><strong>تاريخ الميلاد:</strong> ${application.birthDate || 'غير محدد'}</p>
            <p><strong>الجنس:</strong> ${application.gender || 'غير محدد'}</p>
        </div>
        
        <div class="detail-item">
            <div class="detail-label"><i class="fas fa-phone"></i> معلومات التواصل</div>
            <p><strong>الهاتف:</strong> ${application.phone || 'غير محدد'}</p>
            <p><strong>البريد الإلكتروني:</strong> ${application.email || 'غير محدد'}</p>
            <p><strong>العنوان:</strong> ${application.address || 'غير محدد'}</p>
            <p><strong>المحافظة:</strong> ${application.governorate || 'غير محدد'}</p>
        </div>
        
        <div class="detail-item">
            <div class="detail-label"><i class="fas fa-briefcase"></i> المعلومات المهنية</div>
            <p><strong>المؤهل الدراسي:</strong> ${application.education || 'غير محدد'}</p>
            <p><strong>التخصص:</strong> ${application.specialization || 'غير محدد'}</p>
            <p><strong>سنوات الخبرة:</strong> ${application.experience || 'غير محدد'}</p>
            <p><strong>القطاع المطلوب:</strong> ${application.jobSector || 'غير محدد'}</p>
            <p><strong>الوظائف السابقة:</strong> ${application.previousJobs || 'لا توجد'}</p>
            <p><strong>المهارات:</strong> ${application.skills || 'لا توجد'}</p>
        </div>
        
        <div class="detail-item">
            <div class="detail-label"><i class="fas fa-info-circle"></i> معلومات إضافية</div>
            <p><strong>الراتب المتوقع:</strong> ${application.expectedSalary ? application.expectedSalary + ' جنيه' : 'غير محدد'}</p>
            <p><strong>متاح للبدء:</strong> ${application.availability || 'غير محدد'}</p>
            <p><strong>ملاحظات:</strong> ${application.notes || 'لا توجد'}</p>
            <p><strong>تاريخ التقديم:</strong> ${application.submissionDate || 'غير محدد'}</p>
        </div>
        
        <div class="action-buttons">
            <button class="btn contact-btn" onclick="contactApplicant('${application.phone}', '${application.fullName}')">
                <i class="fas fa-phone"></i> الاتصال بالمتقدم
            </button>
        </div>
    `;
    
    // تمرير إلى الأعلى لعرض التفاصيل
    detailsContent.scrollIntoView({ behavior: 'smooth' });
}

// حذف طلب التوظيف
function deleteApplication(appId) {
    if (!confirm('هل أنت متأكد من حذف هذا الطلب؟ لا يمكن التراجع عن هذا الإجراء.')) {
        return;
    }
    
    let applications = JSON.parse(localStorage.getItem('nileWorkForceApplications')) || [];
    applications = applications.filter(app => app.id != appId);
    
    localStorage.setItem('nileWorkForceApplications', JSON.stringify(applications));
    
    // تحديث العرض
    loadApplications();
    
    // مسح تفاصيل الطلب إذا كان معروضاً
    document.getElementById('detailsContent').innerHTML = '<p>انقر على أي متقدم لعرض التفاصيل الكاملة</p>';
    
    alert('تم حذف الطلب بنجاح');
}

// تصفية الطلبات
function filterApplications() {
    let applications = JSON.parse(localStorage.getItem('nileWorkForceApplications')) || [];
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const sectorFilter = document.getElementById('sectorFilter').value;
    const governorateFilter = document.getElementById('governorateFilter').value;
    
    // تطبيق الفلاتر
    let filteredApplications = applications;
    
    // فلترة البحث
    if (searchTerm) {
        filteredApplications = filteredApplications.filter(app => 
            (app.fullName && app.fullName.toLowerCase().includes(searchTerm)) ||
            (app.nationalId && app.nationalId.includes(searchTerm)) ||
            (app.governorate && app.governorate.includes(searchTerm)) ||
            (app.phone && app.phone.includes(searchTerm))
        );
    }
    
    // فلترة القطاع
    if (sectorFilter) {
        filteredApplications = filteredApplications.filter(app => 
            app.jobSector === sectorFilter
        );
    }
    
    // فلترة المحافظة
    if (governorateFilter) {
        filteredApplications = filteredApplications.filter(app => 
            app.governorate === governorateFilter
        );
    }
    
    // تحديث العرض
    updateStatistics(filteredApplications);
    displayApplications(filteredApplications);
}

// تصدير البيانات
function exportData() {
    const applications = JSON.parse(localStorage.getItem('nileWorkForceApplications')) || [];
    
    if (applications.length === 0) {
        alert('لا توجد بيانات للتصدير');
        return;
    }
    
    // تحويل البيانات إلى CSV
    const headers = ['الاسم', 'الرقم القومي', 'الهاتف', 'البريد الإلكتروني', 'المحافظة', 'القطاع', 'الخبرة', 'التاريخ'];
    
    const csvRows = [
        headers.join(','),
        ...applications.map(app => [
            app.fullName || '',
            app.nationalId || '',
            app.phone || '',
            app.email || '',
            app.governorate || '',
            app.jobSector || '',
            app.experience || '',
            app.submissionDate || ''
        ].join(','))
    ];
    
    const csvString = csvRows.join('\n');
    
    // إنشاء ملف وتنزيله
    const blob = new Blob(['\uFEFF' + csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `nile-workforce-applications-${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('تم تصدير البيانات بنجاح');
}

// الاتصال بالمتقدم
function contactApplicant(phone, name) {
    if (confirm(`هل تريد الاتصال بـ ${name} على الرقم ${phone}؟`)) {
        window.open(`tel:${phone}`, '_blank');
    }
}

// دالة لتغيير كلمة المرور (يمكن إضافتها في نسخة مطورة)
function changePassword() {
    const currentPassword = prompt('أدخل كلمة المرور الحالية:');
    const storedCredentials = JSON.parse(localStorage.getItem('adminCredentials'));
    
    if (currentPassword === storedCredentials.password) {
        const newPassword = prompt('أدخل كلمة المرور الجديدة:');
        const confirmPassword = prompt('أكد كلمة المرور الجديدة:');
        
        if (newPassword === confirmPassword) {
            storedCredentials.password = newPassword;
            localStorage.setItem('adminCredentials', JSON.stringify(storedCredentials));
            alert('تم تغيير كلمة المرور بنجاح');
        } else {
            alert('كلمات المرور غير متطابقة');
        }
    } else {
        alert('كلمة المرور الحالية غير صحيحة');
    }
}
